{
  "cells": [
    {
      "cell_type": "raw",
      "metadata": {},
      "source": [
        "---\n",
        "title: \"DSCI 522 Lecture 8\"\n",
        "subtitle: \"Testing Code & Conclusion\"\n",
        "author: \"Sky Sheng\"\n",
        "execute:\n",
        "  eval: false\n",
        "format:\n",
        "  revealjs:\n",
        "    theme: default\n",
        "    transition: slide\n",
        "    slide-number: true\n",
        "    chalkboard: true\n",
        "    logo: ../images/mds-hex-sticker.png\n",
        "---\n",
        "\n",
        "\n",
        "![](../images/otter_throw_docker.png){width=100% fig-align=\"center\" style=\"position: relative; bottom: 0px; right: 0px;\"}\n",
        "\n",
        "<p style=\"position: fixed; bottom: -40px; right: 5px; font-size: 18px; color: gray; z-index: 1000;\">Image generated by OpenAI GPT-5</p>\n",
        "\n",
        "\n",
        "---"
      ],
      "id": "107822e6"
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "## iClicker: How do you verify your code is working as expected? \n",
        "\n",
        "::: {.smaller style=\"font-size: 0.9em; list-style-type: none;\"}\n",
        "**A.** I stare at it really hard and hope my eyes don't deceive me! üëÄ\n",
        "\n",
        "**B.** I share it with my mentor/supervisor/peer and see if they catch any bugs! ü§ù\n",
        "\n",
        "**C.** I run it once on a small dataset, if it doesn't crash, we're good! üé≤\n",
        "\n",
        "**D.** I write unit tests like a responsible adult (boring but effective) ‚úÖ\n",
        "\n",
        "**E.** I pray for the best! üôè\n",
        ":::\n",
        "\n",
        "## Why do we need to test our code? \n",
        "\n",
        "![](../images/waymo.jpg){width=100% fig-align=\"center\"}\n",
        "\n",
        "<p style=\"position: fixed; bottom: -40px; right: 5px; font-size: 18px; color: gray; z-index: 1000;\">Source: [Waymo](https://waymo.com/waymo-driver/)</p>\n",
        "\n",
        "## When the real-world is out of your test scope...\n",
        "\n",
        "::: {style=\"text-align: center;\"}\n",
        "{{< video https://youtu.be/uPpEMmLO1TE width=\"100%\" height=\"600\" >}}\n",
        ":::\n",
        "\n",
        "# Modularize your script into functions\n",
        "\n",
        "<img src=\"https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExcW1yMHhvcG5oN2Jyc25jcXkyeXdpZXJiMWl2YjNpanN6cmpudmt5ZSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/EOpZ7XsVfTN2E/giphy.gif\" style=\"width: 100%; max-width: 700px; display: block; margin: 0 auto;\"/>\n",
        "\n",
        "<p style=\"position: fixed; bottom: 0px; right: 0px; font-size: 20px; color: gray; z-index: 1000;\">[Source](https://giphy.com)</p>\n",
        "\n",
        "## Tets for your functions should ...\n",
        "::: {.column width=\"70%\"}\n",
        "::: {.smaller style=\"font-size: 0.9em;\"}\n",
        "::: {.incremental}\n",
        "* **controllability**: the code under test needs to be able to be programmatically controlled\n",
        "* **observability**: the outcome of the code under test needs to be able to be verified\n",
        "* **isolateablilty**: the code under test needs to be able to be validated on its own\n",
        "* **automatability**: the tests should be able to be executed automatically\n",
        ":::\n",
        ":::\n",
        ":::\n",
        "\n",
        "::: {.column width=\"30%\"}\n",
        "<img src=\"https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExM3BjYmRwOWM3bHY3cDluYjFkMXBuNTV5cXAzczhiaG85YmtzMWcyZyZlcD12MV9naWZzX3NlYXJjaCZjdD1n/SqmkZ5IdwzTP2/giphy.gif\" style=\"width: 80%; max-width: 700px; display: block; margin: 0 auto;\"/>\n",
        ":::\n",
        "\n",
        "<p style=\"position: fixed; bottom: 0px; right: 5px; font-size: 18px; color: gray; z-index: 1000;\">Source: [Timbers et al. (2023)](https://ubc-dsci.github.io/reproducible-and-trustworthy-workflows-for-data-science/lectures/140-intro-to-testing-code.html); [GIF source](https://giphy.com)</p>\n",
        "\n",
        "## What kinds of tests do we write for our functions?\n",
        "\n",
        "::: {.smaller style=\"font-size: 1em;\"}\n",
        "We have three broad categories of tests, and we should write 2-3 tests for each (or more if the function is complex):\n",
        "\n",
        "1. **Simple expected use cases**\n",
        "\n",
        "2. **Edge cases** (unexpected, or rare use cases)\n",
        "\n",
        "3. **Abnormal, error or adversarial use cases** (error handling)\n",
        ":::\n",
        "\n",
        "## Example: Which cow is missing ?? ü§Ø\n",
        "\n",
        "![](../images/otter_count_cow.png){width=100% fig-align=\"center\"}\n",
        "\n",
        "<p style=\"position: fixed; bottom: -40px; right: 5px; font-size: 18px; color: gray; z-index: 1000;\">Image generated by OpenAI GPT-5</p>\n",
        "\n",
        "## [`Moo4feed` package](https://www.skysheng.io/moo4feed/)\n",
        "\n",
        "::: {.columns}\n",
        "::: {.column width=\"60%\"}\n",
        "* [code coverage report](https://app.codecov.io/gh/skysheng7/moo4feed/tree/main/R)\n",
        "* 2295 tests created and passed\n",
        "* 96% code coverage\n",
        ":::\n",
        "\n",
        "::: {.column width=\"40%\"}\n",
        "![](../images/moo4feed.png){width=100% fig-align=\"center\"}\n",
        ":::\n",
        ":::\n",
        "\n",
        "## 1. Write function documentation first\n",
        "\n",
        "```r\n",
        "#' Check for cows that haven't been seen after noon\n",
        "#'\n",
        "#' This function identifies cows that haven't been seen after noon (12pm)\n",
        "#' and updates the warning data frame accordingly. This is to warn users \n",
        "#' in cases when a cow lost its ear tag and not able to access the feeder \n",
        "#' and drinker.\n",
        "#'\n",
        "#' @param comb List of daily data frames (feed, water or combined).\n",
        "#' @param warn Warning data frame to update\n",
        "#' @param id_col Animal ID column name (default current global value from [id_col2()])\n",
        "#' @param end_col End time column name (default current global value from [end_col2()])\n",
        "#' @param tz Time zone string for date-time operations\n",
        "#' @param verbose Logical. If TRUE, print details of data where errors were detected\n",
        "#'\n",
        "#' @return Updated warning data frame with no-show information\n",
        "qc_no_show <- function(comb,\n",
        "                       warn,\n",
        "                       id_col = id_col2(),\n",
        "                       end_col = end_col2(),\n",
        "                       tz = tz2(),\n",
        "                       verbose = TRUE)\n",
        "```\n",
        "\n",
        "# 2. Plan your test cases ü§î\n",
        "\n",
        "* What are some **expected use cases**? \n",
        "* What are some **edge cases**? \n",
        "* What are some **error cases** ?\n",
        "\n",
        "## 2. Plan your test cases\n",
        "\n",
        "* **Expected use cases**:\n",
        "    * Cow 1 went missing after 11am --> üö®\n",
        "    * Cow 2 stays in the pen all day --> ‚úÖ\n",
        "* **Edge cases**:\n",
        "    * Input dataframe is empty \n",
        "    * Input dataframe only has one row\n",
        "* **Error cases**:\n",
        "    * Input feeding and drinking data is not a dataframe\n",
        "    * Input warning data is not a dataframe\n",
        "\n",
        "## 3. Create simple test data\n",
        "\n",
        "* Example INPUT test data:\n",
        "\n",
        "![](../images/example_test_data.png){width=20% fig-align=\"center\"}\n",
        "\n",
        "## 3. Create simple test data\n",
        "\n",
        "* Example OUTPUT test data:\n",
        "\n",
        "![](../images/example_output.png){width=20% fig-align=\"center\"}\n",
        "\n",
        "# 4. Write the tests\n",
        "\n",
        "Here are the tests I wrote for this function: [`test-qc_no_show.R`](https://github.com/skysheng7/moo4feed/blob/main/tests/testthat/test-qc_no_show.R)\n",
        "\n",
        "# 5. Implement the function\n",
        "\n",
        "Here is the function I implemented [`qc_no_show.R`](https://github.com/skysheng7/moo4feed/blob/main/R/qc_no_show.R)\n",
        "\n",
        "# 6. Iterate and improve üîÅ\n",
        "\n",
        "* Run your tests and see if they pass\n",
        "* If not, check for bugs in your function or tests\n",
        "\n",
        "\n",
        "## Workflow for writing functions and tests : Testing-driven development\n",
        "\n",
        "::: {.incremental}\n",
        "::: {.smaller style=\"font-size: 0.8em;\"}\n",
        "1. **Write function documentation first** - Define the function name, inputs, and outputs. Leave the function body empty for now.\n",
        "\n",
        "2. **Plan your test cases** - Think about what tests you need: normal cases, edge cases, and error cases.\n",
        "\n",
        "3. **Create simple test data** - Make small, easy-to-understand input and expected output data.\n",
        "\n",
        "4. **Write the tests** - Code the tests using your test cases and test data.\n",
        "\n",
        "5. **Implement the function** - Write the actual function code to pass your tests.\n",
        "\n",
        "6. **Iterate and improve** - Go back to steps 2-5 to add more tests and refine your function.\n",
        ":::\n",
        ":::\n",
        "\n",
        "## üôã‚Äç‚ôÄÔ∏è \"Can I use LLMs to help me write tests and code?\"\" \n",
        "\n",
        "::: {.smaller style=\"font-size: 0.8em;\"}\n",
        "YES! BUT...\n",
        "\n",
        "* Use AI in a smart way!\n",
        "* You are the BOSS, you need to know what you want\n",
        "* **Option 1**: \n",
        "  * you design the normal, edge and error handling cases  \n",
        "  * LLM (recommend [Claude](https://claude.ai/)) generate the test code for you\n",
        "  * You review the code thoroughly, edit as needed\n",
        "\n",
        "::: {.callout-important}\n",
        "## Heads up!\n",
        "ü§ñ LLMs are bad at counting... \n",
        ":::\n",
        ":::\n",
        "\n",
        "## System prompts for LLMs\n",
        "\n",
        "* **Option 2**: \n",
        "  * Start with writing code manually yourself, design the standard documentation style, coding style, function signiture style, global variables in the way YOU like.\n",
        "  * Use your technical + domain knowledge to write the system prompts, customize your AI agents to \"duplicate your brain\" and be a helpful 24-7 assistant.\n",
        "  * [system prompt I used in Cursor for `moo4feed` (cursor rules file)](https://github.com/skysheng7/moo4feed/blob/main/.cursor/rules/my-cursor-rules.mdc)\n",
        "\n",
        "\n",
        "# ‚≠êÔ∏è Course evaluation\n",
        "\n",
        "Let's take 10 minutes to fill out the course evaluation form on Canvas. \n",
        "\n",
        "# üßπ Clean up your computataional environment!\n",
        "\n",
        "## ü´ß Clean up your conda environments\n",
        "\n",
        "1. Check all the conda environments you have created.\n",
        "\n",
        "```{bash}\n",
        "conda env list\n",
        "```\n",
        "\n",
        "2. Remove the environment you are not using anymore.\n",
        "\n",
        "```{bash}\n",
        "conda env remove --name <env_name>\n",
        "```\n",
        "\n",
        "## üê≥ Clean up your docker containers: Command line\n",
        "\n",
        "1. Check all the docker containers you have created.\n",
        "\n",
        "```{bash}\n",
        "docker ps -a\n",
        "```\n",
        "\n",
        "2. Remove the container you are not using anymore.\n",
        "\n",
        "```{bash}\n",
        "docker rm <container_id>\n",
        "```\n",
        "\n",
        "\n",
        "‚ö†Ô∏è **Tip**:You may have containers that are still running, and not stopped properly. You need to stop the container before removing it.\n",
        "\n",
        "\n",
        "```{bash}\n",
        "docker stop <container_id>\n",
        "docker rm <container_id>\n",
        "```\n",
        "\n",
        "## üê≥ Clean up your docker containers: Docker Dashboard\n",
        "\n",
        "::: {.smaller style=\"font-size: 0.8em;\"}\n",
        "* Click on \"Containers\" & \"Images\" on the left sidebar ‚û°Ô∏è trash can icon\n",
        ":::\n",
        "![](../images/stop_container.png){style=\"width: 100%;\"}\n",
        "\n",
        "# Fork your group's repository to your own GitHub main page\n",
        "\n",
        "* What is \"Star\" ‚≠êÔ∏è? \n",
        "* What is \"Watch\" üîî? \n",
        "* What is \"Fork\" üç¥? \n",
        "* What is \"Pin\" üìå? \n",
        "\n",
        "# ‚ú® Final remarks\n",
        "\n",
        "## Thank you!\n",
        "\n",
        "::: {.columns}\n",
        "::: {.column width=\"60%\"}\n",
        "::: {.smaller style=\"font-size: 1em;\"}\n",
        "* You have gone above and beyond in your project with Docker!! \n",
        "* This is my first time teaching at MDS, I appreciate your engagement, perseverance in debugging, and patience in the class.\n",
        ":::\n",
        ":::\n",
        "::: {.column width=\"40%\"}\n",
        "![](../images/otter_whale.png){width=100% fig-align=\"center\" style=\"position: relative; bottom: -150px; right: -10px;\"}\n",
        ":::\n",
        ":::\n",
        "\n",
        "<p style=\"position: fixed; bottom: -40px; left: 5px; font-size: 18px; color: gray; z-index: 1000;\">Image generated by OpenAI GPT-5</p>\n",
        "\n",
        "## Hope you always see your values and shines like a star üåü\n",
        "\n",
        "::: {.columns}\n",
        "::: {.column width=\"50%\"}\n",
        "::: {.smaller style=\"font-size: 1em;\"}\n",
        "* This is the last course I teach with the 2025-2026 cohort.\n",
        "* Feel free to message me if you ever need support or confidence boost!\n",
        ":::\n",
        ":::\n",
        "::: {.column width=\"50%\"}\n",
        "![](../images/otter_star.png){width=100% fig-align=\"center\" style=\"position: relative; bottom: -68px; right: -70px;\"}\n",
        ":::\n",
        ":::\n",
        "\n",
        "<p style=\"position: fixed; bottom: -40px; left: 5px; font-size: 18px; color: gray; z-index: 1000;\">Image generated by OpenAI GPT-5</p>"
      ],
      "id": "9f2dbf55"
    }
  ],
  "metadata": {
    "kernelspec": {
      "name": "conda-env-571-py",
      "language": "python",
      "display_name": "Python (conda-env-571-py)",
      "path": "/Users/skysheng/Library/Jupyter/kernels/conda-env-571-py"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 5
}