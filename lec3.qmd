---
title: "DSCI 522 Lecture 3"
subtitle: "Customizing and Building Containers"
author: "Sky Sheng"
execute:
  eval: false
format:
  revealjs:
    theme: default
    transition: slide
    slide-number: true
    chalkboard: true
    logo: images/mds-hex-sticker.png
---

## üò∫ iClicker: How is your group collaboration going?

::: {.column width="33%"}
<div style="text-align: center; font-weight: bold; font-size: 24px; margin-bottom: 10px;">(A)</div>
<div style="text-align: center;">
<img src="https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExdHRiejRzbDhlOGcyNTI5aGc5MTl0ZWJiMnEwNW1tZWFueTQxZDZ3ayZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/gl8ymnpv4Sqha/giphy.gif" style="width: 60%; max-width: 400px;"/>
</div>
:::

::: {.column width="33%"}
<div style="text-align: center; font-weight: bold; font-size: 24px; margin-bottom: 10px;">(B)</div>
<div style="text-align: center;">
<img src="https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExODc3cXlvZHd1MmlybDZxenM5ZTNiOHcyZXd5djFmaDluamRvNWV0ZSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/gcW5zU5Te3qPm/giphy.gif" style="width: 65%; max-width: 400px;"/>
</div>
:::

::: {.column width="33%"}
<div style="text-align: center; font-weight: bold; font-size: 24px; margin-bottom: 10px;">(C)</div>
<div style="text-align: center;">
<img src="https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExa3RvMTcxZXkyOHZlcWY1N2NsYnNndjNndmJobXlzeHd3a3lxeW9oZyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/lJNoBCvQYp7nq/giphy.gif" style="width: 60%; max-width: 400px;"/>
</div>
:::


<p style="position: fixed; bottom: 0px; right: 0px; font-size: 20px; color: gray; z-index: 1000;">[Source](https://giphy.com)</p>

## [Conda](https://ubc-dsci.github.io/reproducible-and-trustworthy-workflows-for-data-science/lectures/085-virtual_env-python-conda.html) Recap: üßê How to...

::: {style="font-size: 0.7em;"}
- Create a new conda environment
- List all conda environments
- Activate a conda environment
- Deactivate a conda environment
- Remove a conda environment
- List all packages in a conda environment
- Remove a package from a conda environment
- Update a package in a conda environment
- Update all packages in a conda environment
- Share a conda environment with someone else
- Create a conda environment from `environment.yml` file
- Duplicate a conda environment
:::

## üìú Conda Cheat Sheet Part 1Ô∏è‚É£ 

::: {style="font-size: 0.7em;"}
| Task | Command |
|------|---------|
| Create a new conda environment | `conda create -n <env_name>` |
| Create with specific Python version | `conda create --name <env_name> python=3.11` |
| Create with packages | `conda create --name <env_name> numpy pandas` |
| List all conda environments | `conda env list` or `conda info --envs` |
| Activate a conda environment | `conda activate <env_name>` |
| Deactivate a conda environment | `conda deactivate` |
| Remove a conda environment | `conda env remove -n <env_name>` |
| List all packages in environment | `conda list` |
| Remove a package from **current** environment| `conda remove <package_name>` |
:::

## üìú Conda Cheat Sheet Part 2Ô∏è‚É£ 

::: {style="font-size: 0.65em;"}
| Task | Command |
|------|---------|
| Update a package in **current** environment | `conda update <package_name>` |
| Remove a package in **other** environment | `conda remove -n <env_name> <package_name>` |
| Update a package in **other** environment | `conda update -n <env_name> <package_name>` |
| Update all packages in **current** environment | `conda update --all` |
| Share environment | `conda env export --from-history > environment.yml` |
| Create conda environment from `environment.yml` | `conda env create --file environment.yml` |
| Duplicate a conda environment | `conda create --name <new_env> --clone <old_env>` |
:::

## üìï Command Line Notes

* `--name` and `-n` are equivalent.
* `--file` and `-f` are equivalent.
* `-p` and `--platform` are equivalent, to specify the platform (e.g., `linux-64`, `osx-arm64`, `win-64`).
* More command line review cheatsheet is [here](https://github.com/skysheng7/linux_command_in_aws_ec2/blob/main/linux_cheatsheet/basic_command_line.md).

## [Conda-lock](https://ubc-dsci.github.io/reproducible-and-trustworthy-workflows-for-data-science/lectures/090-conda-lock.html) Recap

üîí What are the commands for the following tasks?

- Generate a general conda-lock file for all platforms
- Generate a conda-lock file for a specific platform


## üìú Conda-lock Cheat Sheet

::: {style="font-size: 0.7em;"}
|Command | Output |
|-------------------|-------|
|#General file all platforms <br> `conda-lock lock --file environment.yml` | `conda-lock.yml` |
|#General file for one platform (e.g., Linux) <br> `conda-lock lock --file environment.yml -p linux-64` | `conda-lock.yml` |
|#Explicit lock file for one platform (e.g., Linux) <br> `conda-lock -k explicit --file environment.yml -p linux-64` | `conda-linux-64.lock` |
|#Explicit lock file from `conda-lock.yml` <br> `conda-lock render -p linux-64` | `conda-linux-64.lock` |
:::

## üôÄ `conda-lock.yml` VS `conda-linux-64.lock`? {style="font-size: 0.8em;"}

::: {style="font-size: 0.73em;"}
| Feature | `conda-lock.yml` | `conda-linux-64.lock` |
|------|-----------------------|----------------------------|
| **Format** | Unified YAML (multi-platform) | Explicit (single-platform) |
| **Content** | Structured metadata + dependencies for all platforms | Simple list of package URLs |
| **File Size** | Larger (contains all platforms) | Smaller (one platform only) |
| **Installation** | `conda-lock install --name <env_name> conda-lock.yml` | `conda create --name <env_name> --file conda-linux-64.lock` |
| **Use case** | Development across multiple platforms | Production deployment, Docker, single platform |
| **Speed** | Slightly slower (conda-lock processes it) | Fastest |
:::

## Some data science conventions

::: {style="font-size: 0.8em;"}
* üêç Use snake_case for all folder & file names (lowercase + underscore)
* Use Markdown for documentation. 
    * Need a review? [Here is the markdown tutorial](https://www.markdowntutorial.com/)
* yaml (`.yml` or `.yaml`) files for data storage and system configurations (NOT for documentation)
    * YAML = Yet Another Markup Language
    * No use of strict symbols (e.g., braces, square brackets)
    * Use `#` for comments
    * Python style indentation using whitespace (NOT TABS)
    * JSON is **subset** of YAML. JSON file can be parsed by a YAML parser.
:::

## üö¢ Docker Recap

1. ‚ö†Ô∏è Command lines are very sensitive to whitespace and quotation marks! 

```{bash}
docker run \
    --rm \
    -p 8788:8787 \
    -e PASSWORD="apassword" \
    rocker/rstudio:4.4.2

```

2. üè∑Ô∏è Don't use the TAG `latest` for the image, use the specific version tag instead.
3. Docker cheatsheet is available in [textbook](https://ubc-dsci.github.io/reproducible-and-trustworthy-workflows-for-data-science/lectures/110-containerization-2.html)

# We don't like manual work!

<div style="text-align: center;">
  <img src="https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExeWxxaDBuOG1wdnhzcXFhYXc4bzNuZGhjamJrYTRkcjJkemlycWdxMyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/jnhXd7KT8UTk5WIgiV/giphy.gif" style="width: 90%; max-width: 700px;"/>
</div>

<p style="position: fixed; bottom: 10px; right: 10px; font-size: 20px; color: gray; z-index: 1000;">Source: Minions movie</p>


## Docker-compose file: `docker-compose.yml`

```{yaml}
services:
  analysis-env:
    image: rocker/rstudio:4.4.2
    ports:
      - "8789:8787"
    volumes:
      - .:/home/rstudio/project
    environment:
      PASSWORD: password
    deploy:
      resources:
        limits:
          memory: 5G
    platform: linux/amd64
```

## How to use `docker-compose.yml`?

* Launch the container: `docker compose up`
* Stop the container: type `Cntrl + C` in the terminal where you launched the container, and then type `docker-compose rm`
* Read more in the textbook [here](https://ubc-dsci.github.io/reproducible-and-trustworthy-workflows-for-data-science/lectures/115-docker-compose.html)

## Today's topic: Let's build our own [container](https://ubc-dsci.github.io/reproducible-and-trustworthy-workflows-for-data-science/lectures/120-containerization-3.html)!

![](images/docker_otter.png){style="position: fixed; bottom: -100px; left: -55px; margin: 0; padding: 0;"}